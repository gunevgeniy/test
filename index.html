<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Калькулятор стоимости сервиса UIS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Manrope:wght@500;700;800&display=swap" rel="stylesheet">
  
  <!-- Подключение библиотек -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  
  <style>
    :root {
      --color-primary: #0000aa;
      --color-primary-light: rgba(0, 0, 170, 0.08);
      --color-bg: #F0F2F5;
      --color-card-bg: #FFFFFF;
      --color-input-bg: #FFFFFF;
      --color-input-border: #C4C4C4;
      --color-text-main: #252525;
      --color-text-secondary: #878787;
      --color-limit: #e67e22; 
      --radius-card: 20px;
      --radius-input: 10px;
      --shadow-card: 0 4px 20px rgba(0, 0, 0, 0.05);
      --font-head: 'Manrope', sans-serif;
      --font-body: 'Inter', sans-serif;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: var(--font-body); background-color: var(--color-bg); color: var(--color-text-main); margin: 0; padding: 0; overflow-x: hidden; }

    /* Cloud Background */
    .bg-cloud {
      position: fixed; top: -10%; left: -10%; width: 70vw; height: 70vw;
      background: radial-gradient(circle, rgba(0,0,170,0.12) 0%, rgba(255,255,255,0) 70%);
      filter: blur(80px); z-index: -1; pointer-events: none;
    }

    /* Layout */
    .layout-wrapper {
      max-width: 1200px; margin: 0 auto; padding: 40px 20px 140px 20px;
      display: grid; grid-template-columns: 1fr 340px; gap: 30px; align-items: start;
    }
    .main-column { display: flex; flex-direction: column; gap: 24px; }
    .sidebar-column { position: sticky; top: 24px; z-index: 10; }

    /* Cards */
    .card {
      background: var(--color-card-bg); border-radius: var(--radius-card);
      padding: 24px; box-shadow: var(--shadow-card);
    }
    .card-group { position: relative; } 

    .card-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 15px; cursor: pointer;
    }
    .card-header.static { cursor: default; margin-bottom: 20px;} 

    .card-title { font-size: 18px; font-weight: 700; font-family: var(--font-head); color: var(--color-primary); display: flex; align-items: center; gap: 10px;}

    .header-toggle-icon {
        width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent;
        border-top: 8px solid var(--color-primary); transition: transform 0.3s;
    }
    .card-header.collapsed .header-toggle-icon { transform: rotate(-90deg); }

    /* Rows */
    .option-row {
      display: grid; 
      grid-template-columns: 1fr 150px; 
      gap: 15px; 
      padding: 16px 0; 
      border-bottom: 1px solid #eef2f6;
      align-items: center;
    }
    .option-row:last-child { border-bottom: none; }
    
    .option-row.stacked {
        grid-template-columns: 1fr;
        gap: 6px; 
        align-items: start;
    }
    .option-row.stacked .control-wrapper {
        width: 100%;
        justify-content: flex-start;
    }

    .option-info { display: flex; flex-direction: column; gap: 6px; }
    
    .option-name {
      font-weight: 600; 
      font-size: 15px; 
      line-height: 1.4;
      display: block; 
    }

    .option-meta {
      font-size: 12px; display: flex; flex-direction: column; gap: 4px; align-items: flex-start; min-height: 24px; justify-content: center;
    }

    /* Price Badges */
    .price-badge {
      display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 6px; 
      font-weight: 600; font-size: 11px; white-space: nowrap; line-height: 1.4;
    }
    .price-badge.cost { background: #E6F0FF; color: var(--color-primary); }
    .price-badge.limit { background: #FFF4E6; color: var(--color-limit); }

    /* Tooltip Icon */
    .info-icon {
      display: inline-flex; align-items: center; justify-content: center;
      width: 18px; height: 18px;
      background: var(--color-primary-light); color: var(--color-primary);
      border-radius: 50%; font-size: 11px; font-weight: 800; font-family: serif; cursor: pointer;
      vertical-align: middle; 
      margin-left: 4px; 
      margin-bottom: 2px;
    }

    /* Controls */
    .control-wrapper { display: flex; justify-content: flex-end; align-items: center; }

    /* Toggle Switch */
    .toggle-switch { position: relative; display: inline-block; width: 46px; height: 26px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: #D1D1D1; transition: .3s; border-radius: 34px;
    }
    .slider:before {
      position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px;
      background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    input:checked + .slider { background-color: var(--color-primary); }
    input:checked + .slider:before { transform: translateX(20px); }

    /* Stepper */
    .stepper {
      display: flex; align-items: center; 
      background: var(--color-input-bg);
      border: 1px solid var(--color-input-border);
      border-radius: var(--radius-input); 
      padding: 3px; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.03);
    }
    .stepper-btn {
      width: 30px; height: 30px; border: none; background: #F0F4FF;
      border-radius: 8px; color: var(--color-primary); font-weight: 700;
      font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: all 0.2s;
    }
    .stepper-btn:active { background: #dce6ff; }
    .stepper-input {
      width: 50px; border: none; background: transparent; text-align: center;
      font-family: var(--font-body); font-weight: 600; font-size: 15px;
      color: var(--color-text-main); padding: 0; -moz-appearance: textfield; outline: none;
    }
    .stepper-input::selection { background: var(--color-primary-light); }

    /* Custom Select Trigger */
    .custom-select-trigger {
        width: 100%;
        background: var(--color-input-bg);
        border: 1px solid var(--color-input-border);
        padding: 10px 12px;
        border-radius: var(--radius-input);
        font-size: 14px;
        font-weight: 500;
        color: var(--color-text-main);
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        transition: border 0.2s;
        min-height: 42px;
    }
    .custom-select-trigger:hover { border-color: var(--color-primary); }
    .custom-select-trigger::after { content: "▼"; font-size: 10px; opacity: 0.6; margin-left: 8px; }
    .hidden-native-select { display: none; }

    /* Read-only field */
    .readonly-field {
        background: #EAEAEA; padding: 8px 16px; border-radius: var(--radius-input);
        font-weight: 700; color: #555; display: flex; align-items: center; gap: 6px;
        border: 1px solid #ccc;
    }

    /* FMC Container */
    .fmc-container {
      border: 1px solid #D0D0D0; border-radius: 16px; padding: 20px;
      margin-top: 10px; background: #FFFFFF; position: relative;
      box-shadow: 0 4px 10px rgba(0,0,0,0.02);
    }
    .fmc-title {
        font-size: 12px; font-weight: 800; text-transform: uppercase;
        color: var(--color-primary); margin-bottom: 12px; letter-spacing: 0.8px;
    }
    
    .fmc-subgroup { display: flex; flex-direction: column; }
    .fmc-subgroup .option-row { border-bottom: none; padding: 8px 0; }
    .fmc-cost-row { padding-top: 10px; border-top: 1px dashed #e0e0e0; margin-top: 5px; display: flex; justify-content: flex-start; }

    /* Summary Sidebar (Desktop) */
    .summary-card {
      background: var(--color-primary); color: #fff; padding: 24px;
      border-radius: var(--radius-card); box-shadow: 0 10px 40px rgba(0, 0, 170, 0.25);
    }
    .summary-total { text-align: center; margin-bottom: 24px; }
    .summary-total-label { font-size: 14px; opacity: 0.8; margin-bottom: 8px; }
    .summary-total-value { font-size: 32px; font-family: var(--font-head); font-weight: 800; line-height: 1; }
    .summary-currency { font-size: 20px; font-weight: 500; }
    .summary-details { margin-bottom: 24px; }
    .summary-row {
      display: flex; justify-content: space-between; margin-bottom: 14px;
      font-size: 14px; opacity: 0.95; padding-bottom: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.15);
    }
    .summary-row:last-child { border: none; }
    .summary-row span:last-child { font-weight: 700; white-space: nowrap;}
    
    .button-group { display: flex; gap: 10px; }
    .btn-reset { flex: 1; padding: 14px; background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: #fff; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 14px; transition: background 0.3s; }
    .btn-reset:hover { background: rgba(255,255,255,0.25); }
    .btn-print { flex: 1; padding: 14px; background: #fff; border: none; color: var(--color-primary); border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 14px; transition: transform 0.2s; }
    .btn-print:hover { transform: scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

    /* Expert Toggle Button */
    .expert-toggle-btn {
        display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        background: #FFFFFF; border: 1px solid #D0D0D0;
        color: var(--color-primary); font-weight: 700;
        cursor: pointer; 
        font-size: 14px; margin-top: 20px; transition: all 0.2s;
        padding: 12px 24px; border-radius: 30px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .expert-toggle-btn:hover { background: #F8F9FC; border-color: var(--color-primary); }
    .expert-toggle-btn .toggle-icon {
        width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent;
        border-top: 6px solid var(--color-primary); transition: transform 0.3s;
    }
    .expert-toggle-btn.active .toggle-icon { transform: rotate(180deg); }
    
    .expert-block { display: none; margin-top: 20px; padding-top: 10px; border-top: 1px dashed #e0e0e0; }

    /* BOTTOM SHEET */
    .bottom-sheet { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; z-index: 500; box-shadow: 0 -5px 30px rgba(0,0,0,0.15); border-radius: 24px 24px 0 0; flex-direction: column; transition: transform 0.3s ease; }
    .sheet-header { padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; background: var(--color-primary); color: white; border-radius: 24px 24px 0 0; cursor: pointer; }
    .sheet-main-info { display: flex; align-items: center; justify-content: space-between; width: 100%; }
    .sheet-label { font-size: 14px; opacity: 0.9; font-weight: 500; }
    .sheet-price { font-family: var(--font-head); font-weight: 800; font-size: 20px; white-space: nowrap; margin-left: 10px;}
    .sheet-icon { transition: transform 0.3s; font-size: 12px; opacity: 0.7; margin-left: 10px; }
    .sheet-content { padding: 24px; display: none; background: #fff; max-height: 60vh; overflow-y: auto; }
    .sheet-content.open { display: block; }
    .sheet-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; color: #333; align-items: center; }
    .sheet-reset { margin-top: 20px; width: 100%; padding: 14px; background: #F0F0F0; color: #333; border: none; border-radius: 12px; font-weight: 700; }

    /* MODALS */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; opacity: 0; transition: opacity 0.2s; }
    .modal-overlay.open { display: flex; opacity: 1; }
    .modal-content { background: #fff; padding: 25px; border-radius: 24px; max-width: 400px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.2); position: relative; max-height: 80vh; overflow-y: auto; }
    .modal-close { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: #aaa; z-index: 5; }
    .modal-text { font-size: 14px; line-height: 1.6; color: #444; }
    .modal-options-list { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
    .modal-option-item { padding: 12px 16px; background: #F5F7FA; border-radius: 12px; cursor: pointer; font-weight: 500; transition: background 0.2s; display: flex; justify-content: space-between; align-items: center; }
    .modal-option-item:hover { background: #E6F0FF; color: var(--color-primary); }
    .modal-option-item.selected { background: var(--color-primary); color: white; }
    .modal-title { font-family: var(--font-head); font-weight: 700; font-size: 18px; margin-bottom: 15px; display: block; }

    /* Manager Form Styles */
    .manager-form { display: flex; flex-direction: column; gap: 15px; }
    .form-group label { font-size: 13px; font-weight: 600; color: var(--color-text-secondary); margin-bottom: 5px; display: block; }
    .form-group input { width: 100%; padding: 12px; border: 1px solid #D0D0D0; border-radius: 10px; font-size: 15px; outline: none; transition: border 0.2s; }
    .form-group input:focus { border-color: var(--color-primary); }
    .form-group input.invalid { border-color: #ff4d4f; background: #fff1f0; }
    .btn-manager-print { width: 100%; padding: 14px; background: var(--color-primary); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; font-size: 16px; margin-top: 10px; }
    .btn-manager-print:hover { background: #000088; }

    /* PRINT STYLES */
    @page {
        size: A4;
        margin: 0.8cm;
    }

    #print-area { display: none; }

    /* Styles applied when printing or when generating PDF */
    @media print {
        body { background: white; color: black; font-family: 'Inter', sans-serif; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .layout-wrapper, .bg-cloud, .bottom-sheet, .modal-overlay, .expert-toggle-btn, #mobile-toast { display: none !important; }
        #print-area { display: flex !important; flex-direction: column; padding: 0; min-height: 100vh; }
    }

    /* Helper class to simulate print styles for html2pdf generation */
    .pdf-mode {
        overflow: visible !important;
        height: auto !important;
    }
    .pdf-mode body { background: white; color: black; overflow: visible !important; }
    .pdf-mode .layout-wrapper, 
    .pdf-mode .bg-cloud, 
    .pdf-mode .bottom-sheet, 
    .pdf-mode .modal-overlay, 
    .pdf-mode .expert-toggle-btn,
    .pdf-mode #mobile-toast { display: none !important; }
    
    .pdf-mode #print-area { 
        display: block !important; 
        position: relative !important; 
        top: auto;
        left: auto;
        width: 750px !important; 
        max-width: 750px !important;
        margin: 0 !important;
        padding: 20px !important; 
        box-sizing: border-box !important;
        min-height: 100vh;
        z-index: 99999;
        background: white;
    }

    /* Print Layout Shared Styles */
    .print-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 3px solid var(--color-primary); padding-bottom: 20px; }
    .print-logo { font-family: 'Manrope', sans-serif; font-weight: 800; font-size: 32px; color: var(--color-primary); }
    .print-title { font-size: 18px; font-weight: 700; text-transform: uppercase; color: #333; }
    
    .print-manager { margin-bottom: 30px; padding: 15px; background: #F8F9FC; border-radius: 12px; border: 1px solid #eee; }
    .print-manager h3 { margin: 0 0 10px 0; font-size: 14px; color: var(--color-primary); text-transform: uppercase; }
    .print-manager p { margin: 4px 0; font-size: 14px; color: #333; }

    /* Grouping Logic Styles */
    .print-section { 
        margin-bottom: 20px; 
        page-break-inside: auto; 
        break-inside: auto;
        border: 1px solid #e0e0e0;
        border-radius: 16px;
        padding: 15px 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        background: #fff;
    }
    
    .print-section-title { display: none; }

    .print-table { width: 100%; border-collapse: collapse; }
    .print-table td { padding: 10px 5px; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }
    
    /* PREVENT ROWS FROM SPLITTING */
    .print-table tr { 
        page-break-inside: avoid; 
        break-inside: avoid; 
    }
    .print-table tr:last-child td { border-bottom: none; }
    
    .print-row-name { font-weight: 700; font-size: 14px; color: #000; margin-bottom: 2px; }
    .print-row-desc { font-size: 10px; color: #777; line-height: 1.3; white-space: pre-wrap; margin-top: 4px; }
    .print-row-value { font-weight: 600; font-size: 13px; text-align: right; white-space: nowrap; }
    
    /* Totals Block */
    .print-totals { 
        background: #F0F2F5; 
        border-radius: 16px; 
        padding: 25px; 
        margin-top: 30px; 
        margin-bottom: 30px;
        page-break-inside: avoid; 
        break-inside: avoid;
    }
    .print-total-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 13px; }
    .print-total-row.main { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #ccc; align-items: center; }
    .print-total-row.main .label { font-size: 18px; font-weight: 800; color: var(--color-primary); text-transform: uppercase; }
    .print-total-row.main .value { font-size: 28px; font-weight: 800; color: var(--color-primary); }
    .print-total-helper { display: block; font-size: 9px; color: #777; margin-top: 2px; line-height: 1.4; max-width: 300px; white-space: pre-wrap; }

    /* Social Block */
    .print-social { 
        margin-top: auto; 
        padding-top: 20px; 
        border-top: 2px solid #eee; 
        page-break-inside: avoid; 
        break-inside: avoid;
    }
    .print-social-title { display: none; }
    
    .print-social-list { 
        display: grid; 
        grid-template-columns: 1fr 1fr 1fr; 
        gap: 12px; 
    }
    .print-social-link { 
        font-size: 11px; 
        color: #777; 
        text-decoration: none; 
        display: flex; 
        align-items: center;
        justify-content: center;
        background: #fcfcfc;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #eee;
        transition: 0.2s;
    }
    .print-social-link span { 
        font-weight: 700; 
        color: #666; 
        margin-right: 0;
    }

    @media (max-width: 900px) {
      .layout-wrapper { grid-template-columns: 1fr; }
      .sidebar-column { display: none; }
      .bottom-sheet { display: flex; }
      .option-row { grid-template-columns: 1fr 140px; gap: 10px; } 
      .option-row.stacked { grid-template-columns: 1fr; }
      .card { padding: 16px; }
    }
    .tooltip-content-hidden { display: none; }
  </style>
</head>
<body>

<!-- Универсальное уведомление (Toast) -->
<div id="mobile-toast" style="display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: rgba(0,0,0,0.85); color: white; padding: 16px; border-radius: 12px; z-index: 99999; text-align: center; font-size: 14px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); transition: opacity 0.3s;">
    <div id="toast-title" style="font-size: 16px; font-weight: 700; margin-bottom: 8px;">⏳ Формирование файла...</div>
    <div id="toast-message" style="font-size: 13px; opacity: 0.9; line-height: 1.4;">
        Если скачивание не началось — нажмите <b>•••</b> сверху &rarr; <b>Открыть в браузере</b>.
    </div>
    <button onclick="document.getElementById('mobile-toast').style.display='none'" style="margin-top: 15px; background: white; color: black; border: none; padding: 8px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 13px;">ОК</button>
</div>

<div class="bg-cloud"></div>

<div class="layout-wrapper">
  
  <!-- Left Column: Options -->
  <div class="main-column">
    
    <!-- ВСТАВЛЯЕМ СЮДА ВЕСЬ ВАШ HTML КОД (СЕКЦИИ CARD, BLOCKS И Т.Д.) -->
    <!-- Для краткости я его пропускаю, так как он не меняется -->
    <!-- ... (Ваш HTML от <section class="card"> до конца страницы) ... -->
    <!-- ВАЖНО: Весь контент HTML (Cards, Options, Sidebar) должен быть здесь, как в исходнике -->
    
    <!-- BLOCK 1: VATS -->
    <section class="card card-group">
      <div class="card-header static">
        <div class="card-title">Настройки ВАТС и номеров</div>
      </div>

      <div class="option-row">
        <div class="option-info">
          <div class="option-name">
            Виртуальная АТС
            <span class="info-icon" onclick="openTooltip('tooltip-vats')">i</span>
          </div>
          <div class="option-meta">
            <span id="cost-VATS"></span>
            <span id="limit-VATS"></span>
          </div>
        </div>
        <div class="control-wrapper">
          <label class="toggle-switch">
            <input type="checkbox" id="VATS" onchange="runCascade('VATS')">
            <span class="slider"></span>
          </label>
        </div>
      </div>

      <!-- ... ВСЕ ОСТАЛЬНЫЕ БЛОКИ (OMNI, ANALYTICS, INTEGRATIONS) ОСТАЮТСЯ КАК БЫЛИ ... -->
      <!-- Я дублирую здесь основные блоки для целостности -->
      
      <div class="option-row">
        <div class="option-info">
            <div class="option-name">
                ВАТС Pro (максимум возможностей)
                <span class="info-icon" onclick="openTooltip('tooltip-vatspro')">i</span>
            </div>
            <div class="option-meta">
                <span id="cost-VATSPRO"></span>
                <span id="limit-VATSPRO"></span>
            </div>
        </div>
        <div class="control-wrapper">
            <label class="toggle-switch">
                <input type="checkbox" id="VATSPRO" onchange="runCascade('VATSPRO')">
                <span class="slider"></span>
            </label>
        </div>
      </div>
      
      <!-- ... (Пропущено для экономии места, вставьте сюда все остальные <div class="option-row">) ... -->
      <!-- ВАЖНО: Не забудьте вставить все блоки, которые были в исходном коде -->
      
      <!-- ДЛЯ ПРИМЕРА Я ВСТАВЛЮ ТОЛЬКО КЛЮЧЕВЫЕ БЛОКИ ДЛЯ ТЕСТА -->
      <div class="option-row">
        <div class="option-info">
            <div class="option-name">Кол-во сотрудников ВАТС</div>
            <div class="option-meta"><span id="cost-KolvoSotrudnikovVATS"></span><span id="limit-KolvoSotrudnikovVATS"></span></div>
        </div>
        <div class="control-wrapper">
            <div class="stepper">
                <button class="stepper-btn" onclick="stepInput('KolvoSotrudnikovVATS', -1)">−</button>
                <input type="text" inputmode="numeric" class="stepper-input" id="KolvoSotrudnikovVATS" value="0" onchange="runCascade('KolvoSotrudnikovVATS')">
                <button class="stepper-btn" onclick="stepInput('KolvoSotrudnikovVATS', 1)">+</button>
            </div>
        </div>
      </div>
      
      <!-- ... и так далее до конца main-column ... -->
      
    </section>
    
    <!-- ... BLOCK 2, BLOCK 3, BLOCK 4 ... -->
    <!-- (Вставьте сюда остальные секции из вашего исходного кода) -->
    
    <!-- (Временно закрываю main-column, чтобы код был валидным) -->
  </div> 
  
  <!-- Right Column -->
  <div class="sidebar-column">
    <div class="summary-card">
      <div class="summary-total">
        <div class="summary-total-label">Ежемесячный платёж</div>
        <div class="summary-total-value">
          <span id="total-monthly">0</span> <span class="summary-currency">₽ / мес</span>
        </div>
      </div>
      <div class="summary-details">
        <div class="summary-row">
          <span>Минимальный счет на связь <span class="info-icon" onclick="openTooltip('tooltip-min8800')" style="background:rgba(255,255,255,0.2);color:white">i</span></span>
          <span id="total-minimal">0</span>
        </div>
        <div class="summary-row">
          <span>Подключение номеров <span class="info-icon" onclick="openTooltip('tooltip-connect')" style="background:rgba(255,255,255,0.2);color:white">i</span></span>
          <span id="total-connection">0</span>
        </div>
        <div class="summary-row">
          <span>Доставка FMC-сим карт <span class="info-icon" onclick="openTooltip('tooltip-delivery')" style="background:rgba(255,255,255,0.2);color:white">i</span></span>
          <span id="total-delivery">0</span>
        </div>
        <div class="summary-row">
          <span>Гарантийный взнос <span class="info-icon" onclick="openTooltip('tooltip-guarantee')" style="background:rgba(255,255,255,0.2);color:white">i</span></span>
          <span id="total-guarantee">0</span>
        </div>
      </div>
      <div class="button-group">
          <button class="btn-reset" onclick="resetForm()">Стереть расчет</button>
          <button class="btn-print" onclick="openManagerModal()">Печать КП</button>
      </div>
    </div>
  </div>

</div>

<!-- MOBILE BOTTOM SHEET -->
<div class="bottom-sheet" id="mobileSheet">
    <div class="sheet-header" onclick="toggleSheet()">
        <div class="sheet-main-info">
            <div class="sheet-label">Ежемесячный платеж</div>
            <div class="sheet-price"><span id="mobile-total">0</span></div>
        </div>
        <div class="sheet-icon">▲</div>
    </div>
    <div class="sheet-content">
        <div class="sheet-row">
            <span>Минимальный счет на связь <span class="info-icon" onclick="openTooltip('tooltip-min8800')">i</span></span>
            <span id="mobile-minimal">0</span>
        </div>
        <div class="sheet-row">
            <span>Подключение номеров <span class="info-icon" onclick="openTooltip('tooltip-connect')">i</span></span>
            <span id="mobile-connection">0</span>
        </div>
        <div class="sheet-row">
            <span>Доставка FMC-сим карт <span class="info-icon" onclick="openTooltip('tooltip-delivery')">i</span></span>
            <span id="mobile-delivery">0</span>
        </div>
        <div class="sheet-row">
            <span>Гарантийный взнос <span class="info-icon" onclick="openTooltip('tooltip-guarantee')">i</span></span>
            <span id="mobile-guarantee">0</span>
        </div>
        <button class="sheet-reset" onclick="resetForm(); toggleSheet()">Стереть расчет</button>
        <button class="btn-manager-print" style="background:#0000aa; color:white; margin-top:10px;" onclick="openManagerModal()">Печать КП</button>
    </div>
</div>

<!-- INFO MODAL -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal(event, true)">&times;</span>
        <div class="modal-text" id="modalText"></div>
    </div>
</div>

<!-- MANAGER MODAL -->
<div class="modal-overlay" id="managerModal" onclick="closeManagerModal(event)">
    <div class="modal-content">
        <span class="modal-close" onclick="closeManagerModal(event, true)">&times;</span>
        <span class="modal-title">Контактные данные</span>
        <div class="manager-form">
            <div class="form-group">
                <label>ФИО Менеджера</label>
                <input type="text" id="mgrName" placeholder="Иванов Иван Иванович" oninput="formatName(this)">
            </div>
            <div class="form-group">
                <label>Телефон</label>
                <input type="text" id="mgrPhone" placeholder="+7 (999) 999-99-99" oninput="formatPhone(this)">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="mgrEmail" placeholder="manager@uiscom.ru" onblur="validateEmail(this)" oninput="this.classList.remove('invalid'); this.value = this.value.replace(/[^a-zA-Z0-9@._-]/g, '');">
            </div>
            <!-- ВАЖНО: type="button" предотвращает перезагрузку страницы -->
            <button type="button" class="btn-manager-print" onclick="printKP()">Сформировать и напечатать</button>
        </div>
    </div>
</div>

<!-- SELECT MODAL -->
<div class="modal-overlay" id="selectModalOverlay" onclick="closeSelectModal(event)">
    <div class="modal-content">
        <span class="modal-close" onclick="closeSelectModal(event, true)">&times;</span>
        <span class="modal-title" id="selectModalTitle">Выбор</span>
        <div class="modal-options-list" id="selectModalOptions"></div>
    </div>
</div>

<!-- HIDDEN PRINT AREA -->
<div id="print-area">
    <div class="print-header">
        <div class="print-logo">UIS</div>
        <div class="print-title">Коммерческое предложение</div>
    </div>
    <div id="print-manager-block" class="print-manager" style="display:none;">
        <h3>Ваш персональный менеджер:</h3>
        <p id="print-mgr-name"></p>
        <p id="print-mgr-phone"></p>
        <p id="print-mgr-email"></p>
    </div>
    <div id="print-sections-container"></div>
    
    <div class="print-totals">
        <div class="print-total-row main">
            <span class="label">Ежемесячный платёж</span>
            <span class="value" id="print-total-monthly">0 ₽</span>
        </div>
        <div class="print-total-row">
            <div>
                <span>Минимальный счет на связь</span>
                <span class="print-total-helper" id="print-total-minimal-desc">Расходуется на звонки с номерами 8-800</span>
            </div>
            <span id="print-total-minimal">0 ₽</span>
        </div>
        <div class="print-total-row">
            <div>
                <span>Подключение номеров</span>
                <span class="print-total-helper">Разово за подключаемые номера и/или FMC-сим карты</span>
            </div>
            <span id="print-total-connection">0 ₽</span>
        </div>
        <div class="print-total-row">
            <div>
                <span>Доставка FMC-сим карт</span>
                <span class="print-total-helper">Разово за один адрес</span>
            </div>
            <span id="print-total-delivery">0 ₽</span>
        </div>
        <div class="print-total-row" style="margin-top:15px; padding-top:15px; border-top:1px solid #ddd;">
            <div>
                <span>Гарантийный взнос</span>
                <span class="print-total-helper" id="print-total-guarantee-desc"></span>
            </div>
            <span id="print-total-guarantee" style="font-weight:700">0 ₽</span>
        </div>
    </div>

    <div class="print-social">
        <div class="print-social-title"></div>
        <div class="print-social-list">
            <a href="https://t.me/uis_technology" target="_blank" class="print-social-link"><span>Оперативная информация</span></a>
            <a href="https://t.me/uiscom_ru" target="_blank" class="print-social-link"><span>UIS говорит</span></a>
            <a href="https://vk.com/uiscom" target="_blank" class="print-social-link"><span>ВКонтакте</span></a>
            <a href="https://vc.ru/uiscom" target="_blank" class="print-social-link"><span>Блог на VC.ru</span></a>
            <a href="https://rutube.ru/channel/24800224/" target="_blank" class="print-social-link"><span>RUTUBE</span></a>
            <a href="https://dzen.ru/id/5d4a870ef2df2500ae39c4ad?share_to=link" target="_blank" class="print-social-link"><span>Дзен</span></a>
        </div>
    </div>
</div>

<!-- Tooltips -->
<div class="tooltip-content-hidden">
    <div id="tooltip-vats">Базовый функционал сценариев:<br>- инф. сообщение<br>- меню<br>- переадресация на сотрудника и группу<br>- распределение по графикам<br>- распределение на персонального менеджера из CRM<br><br>Распределение звонков:<br>- по приоритету<br>- одновременно<br><br>До 3 номеров у сотрудника (сип/личный/FMC).<br>Управление АОНами.<br>Оценка разговора.</div>
    <div id="tooltip-vatspro">ВСЕ функции сценариев и распределения звонков:<br>- на последнего менеджера<br>- по спискам АОНов<br>- по данным из CRM<br>- по регионам/номеру/сегментам и пр.<br>- по процентам<br>- уравнивание по кол-ву или длительности<br>- не звонить ранее, чем через<br>- коллаут<br>- коллбек<br><br>Доп. функции:<br>- управление АОНами<br>- опции разговора<br>- тренер<br><br>- до 6 номеров у сотрудника<br>- SIPURI - канальность 2</div>
    <div id="tooltip-8800">700р. - мин. счет, расходуется на звонки</div>
    <div id="tooltip-own">Подключение номера своего оператора, если предоставляет SIP-настройки (логин, пароль и хост)</div>
    <div id="tooltip-fmc">Портация своих номеров - 0 руб. (только сим МСК и обл.)</div>
    <div id="tooltip-waba">Cтоимость диалогов:<br>- маркетинговые шаблоны: 9,2р.<br>- авторизационные шаблоны: 5,52р.<br>- пользовательские шаблоны: 4,94р.<br>- сервисные шаблоны: 4,6р.</div>
    <div id="tooltip-omniknopka">Виджет, форма, кнопка с мессенджерами. Оформление гибко настраивается</div>
    <div id="tooltip-ar">- Веб аналитика - фиксируем трафик на сайте, распределяем по источникам<br>- Запись звонков, прослушка, тегирование<br>- Забираем заявки с сайта (JS API)<br>- Интеграция с Марквиз и Тильда<br>- Интеграция с рекламными системами и с метрикой<br>- Шаблонные отчеты (сводные) без возможности редактирования<br>- Сырые данные (отчеты)<br>- Настройка целей</div>
    <div id="tooltip-traffic">0,2р/посетитель без и сверх пакета</div>
    <div id="tooltip-kt">- Статический КТ<br>- Динамический КТ + резервные<br>- Мониторинг КТ и т.д.</div>
    <div id="tooltip-report">- создание своих отчетов (сводные, дашборды, сырые данные)<br>- создание своих столбцов и вложенности<br>- использование атрибуции (вся мультиканальная аналитика)<br><br>Без опции доступны шаблонные отчеты, в которых нельзя ничего менять</div>
    <div id="tooltip-crm">Загрузка сделок из CRM в UIS</div>
    <div id="tooltip-otrasl">API, Webhook и загрузка звонков из внешней системы.<br><br>Лимиты на кол-во запросов:<br>DataAPI в минуту — 1–60 = 0; 61–900 = 15 руб.<br>DataAPI в день — 1–500 = 0; 501–1200000 = 0.06 руб.<br>HTTP-уведомления в день — 1–500 = 0; 501–1200000 = 0.02 руб.<br>HTTP-уведомления в минуту — 1–60 = 0; 61–900 = 15 руб.<br>Call API в день — 1–500 = 0; 501–40000 = 1 руб.<br>Call API в минуту — 1–15 = 0; 16–300 = 10 руб.</div>
    <div id="tooltip-notify">Уведомления по E-mail и SMS (SMS — 3.7 руб/шт)</div>
    <div id="tooltip-ats">Звонки между UIS и внешней АТС по коротким добавочным через SMART-транк</div>
    <div id="tooltip-save">- Автоматический перезвон по пропущенным<br>- Автотегирование<br>- Уведомления по E-mail и SMS (SMS — 3.7 руб/шт)<br>- Дашборд с аналитикой по звонкам</div>
    <div id="tooltip-home">Автоматический выбор номера при исходящих звонках</div>
    <div id="tooltip-min8800">Расходуется на звонки с номерами 8-800</div>
    <div id="tooltip-guarantee">Будет "заморожен" на счете как гарантия оплаты и возвращен или учтен при закрытии договора.</div>
    <div id="tooltip-widget">Интеграция аналитики рекламы с виджетами клиента</div>
    <div id="tooltip-connect">Разово за подключаемые номера и/или FMC-сим карты</div>
    <div id="tooltip-delivery">Разово за один адрес</div>
    <div id="tooltip-delivery-main">Указана разовая стоимость доставки на один адрес</div>
</div>

<script>
    /* --- UI LOGIC --- */
    
    function toggleExpert() {
        const block = document.getElementById('block-expert');
        const trigger = document.querySelector('.expert-toggle-btn');
        const isHidden = block.style.display === "none";
        block.style.display = isHidden ? "block" : "none";
        trigger.classList.toggle('active', isHidden);
    }

    function toggleAnalytics() {
        const block = document.getElementById('block-ar');
        const header = document.querySelector('.card-header.collapsed, .card-header:not(.static)');
        const isHidden = block.style.display === "none";
        block.style.display = isHidden ? "block" : "none";
        if(header) header.classList.toggle('collapsed', !isHidden);
    }

    function stepInput(id, delta) {
        const input = document.getElementById(id);
        if(input.disabled) return;
        let val = parseInt(input.value) || 0;
        val += delta;
        if (val < 0) val = 0;
        input.value = val;
        runCascade(id);
    }

    function openTooltip(contentId) {
        const text = document.getElementById(contentId).innerHTML;
        document.getElementById('modalText').innerHTML = text;
        document.getElementById('modalOverlay').classList.add('open');
    }

    function closeModal(e, force) {
        if (force || e.target.id === 'modalOverlay') {
            document.getElementById('modalOverlay').classList.remove('open');
        }
    }

    let currentSelectId = null;

    function openSelectModal(selectId, title) {
        currentSelectId = selectId;
        const nativeSelect = document.getElementById(selectId);
        const options = Array.from(nativeSelect.options);
        const container = document.getElementById('selectModalOptions');
        const modalTitle = document.getElementById('selectModalTitle');
        
        container.innerHTML = '';
        modalTitle.textContent = title || "Выберите опцию";
        
        options.forEach(opt => {
            const item = document.createElement('div');
            item.className = 'modal-option-item';
            if (opt.selected) item.classList.add('selected');
            item.textContent = opt.text;
            item.onclick = () => selectOptionInModal(opt.value);
            container.appendChild(item);
        });

        document.getElementById('selectModalOverlay').classList.add('open');
    }

    function selectOptionInModal(value) {
        const nativeSelect = document.getElementById(currentSelectId);
        nativeSelect.value = value;
        document.getElementById('selectModalOverlay').classList.remove('open');
        updateSelectTrigger(currentSelectId);
        runCascade(currentSelectId);
    }

    function closeSelectModal(e, force) {
        if (force || e.target.id === 'selectModalOverlay') {
            document.getElementById('selectModalOverlay').classList.remove('open');
        }
    }
    
    function updateSelectTrigger(id) {
        const nativeSelect = document.getElementById(id);
        const trigger = nativeSelect.parentElement.querySelector('.custom-select-trigger');
        if (trigger) {
            trigger.textContent = nativeSelect.options[nativeSelect.selectedIndex].text;
        }
    }
    
    let isSheetOpen = false;
    function toggleSheet() {
        const content = document.querySelector('.sheet-content');
        const icon = document.querySelector('.sheet-icon');
        isSheetOpen = !isSheetOpen;
        
        if (isSheetOpen) {
            content.classList.add('open');
            icon.style.transform = "rotate(180deg)";
        } else {
            content.classList.remove('open');
            icon.style.transform = "rotate(0deg)";
        }
    }

    function updateMobileSheet(total, minimal, connect, delivery, guarantee) {
        document.getElementById('mobile-total').textContent = total;
        document.getElementById('mobile-minimal').textContent = minimal;
        document.getElementById('mobile-connection').textContent = connect;
        document.getElementById('mobile-delivery').textContent = delivery;
        document.getElementById('mobile-guarantee').textContent = guarantee;
    }

    document.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => {
      input.addEventListener("focus", function() { this.select(); });
      if (!input.id.startsWith("mgr")) {
        input.addEventListener("blur", () => { if (input.value === "") input.value = "0"; });
      }
    });

    function openManagerModal() {
        document.getElementById('managerModal').classList.add('open');
    }
    
    function closeManagerModal(e, force) {
        if (force || e.target.id === 'managerModal') {
            document.getElementById('managerModal').classList.remove('open');
        }
    }

    function formatName(input) {
        let val = input.value;
        val = val.replace(/(?:^|\s)\S/g, l => l.toUpperCase());
        input.value = val;
    }

    function formatPhone(input) {
        let val = input.value.replace(/\D/g, '');
        if (val.length > 0) {
            if (val[0] === '8' || val[0] === '7') val = val.substring(1);
            let formatted = '+7 ';
            if (val.length > 0) formatted += '(' + val.substring(0, 3);
            if (val.length >= 4) formatted += ') ' + val.substring(3, 6);
            if (val.length >= 7) formatted += '-' + val.substring(6, 8);
            if (val.length >= 9) formatted += '-' + val.substring(8, 10);
            input.value = formatted;
        } else {
            input.value = '';
        }
    }

    function validateEmail(input) {
        const regex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,10}$/;
        if (!regex.test(input.value) && input.value !== "") {
            input.classList.add('invalid');
            return false;
        } else {
            input.classList.remove('invalid');
            return true;
        }
    }

    // Хелпер для показа красивых уведомлений
    function showToast(title, message, duration = 5000) {
        const toast = document.getElementById('mobile-toast');
        document.getElementById('toast-title').innerHTML = title;
        document.getElementById('toast-message').innerHTML = message;
        
        toast.style.display = 'block';
        
        if (duration > 0) {
            setTimeout(() => {
                toast.style.display = 'none';
            }, duration);
        }
    }

    async function printKP() {
        // --- ВАШИ НАСТРОЙКИ ---
        const SERVER_URL = "https://gunevgeniy-uis-pdf-server-eeac.twc1.net/generate-pdf";
        // -----------------------

        saveStateToURL();

        const nameInput = document.getElementById('mgrName');
        const phoneInput = document.getElementById('mgrPhone');
        const emailInput = document.getElementById('mgrEmail');
        
        if (emailInput.value !== "" && !validateEmail(emailInput)) {
            alert("Пожалуйста, введите корректный Email");
            return;
        }

        const name = nameInput.value.trim();
        const phone = phoneInput.value.trim();
        const email = emailInput.value.trim();
        
        const mgrBlock = document.getElementById('print-manager-block');
        if (name || phone || email) {
            mgrBlock.style.display = 'block';
            document.getElementById('print-mgr-name').textContent = name || '';
            document.getElementById('print-mgr-phone').textContent = phone || '';
            document.getElementById('print-mgr-email').textContent = email || '';
        } else {
            mgrBlock.style.display = 'none';
        }

        // --- ГЕНЕРАЦИЯ ТАБЛИЦЫ ---
        const container = document.getElementById('print-sections-container');
        container.innerHTML = ''; 
        const sections = document.querySelectorAll('.card');
        
        sections.forEach(card => {
            const titleEl = card.querySelector('.card-title');
            if (!titleEl) return;
            const titleText = titleEl.textContent.trim();
            const optionRows = card.querySelectorAll('.option-row');
            const tableRows = [];
            let pendingFMC = null;

            optionRows.forEach(row => {
                const checkbox = row.querySelector('input[type="checkbox"]');
                const number = row.querySelector('input[type="number"], input.stepper-input');
                const select = row.querySelector('select');
                const readonly = row.querySelector('#NomeraVATSVsego');
                let isActive = false;
                let valueText = "";
                
                if (checkbox && checkbox.checked) { isActive = true; valueText = "Включено"; } 
                else if (number) {
                    const numVal = parseInt(number.value) || 0;
                    if (number.id === 'LiniyGrupovogoVizova') { if (numVal > 3) isActive = true; } 
                    else if (number.id === 'LiniyIshodyashihZvonkov') { if (numVal > 30) isActive = true; } 
                    else if (numVal > 0) { isActive = true; }
                    if (isActive) valueText = number.value + " шт.";
                } else if (select && select.value !== "0" && select.value !== "нет") {
                    isActive = true;
                    valueText = select.options[select.selectedIndex].text;
                } else if (readonly && parseInt(readonly.value) > 0) {
                    isActive = true;
                    valueText = readonly.value + " шт.";
                }

                if (isActive) {
                    const nameEl = row.querySelector('.option-name');
                    let nameText = nameEl.innerText.replace('i', '').trim();
                    const infoIcon = row.querySelector('.info-icon');
                    let descText = "";
                    if (infoIcon) {
                        const onClickAttr = infoIcon.getAttribute('onclick');
                        if (onClickAttr) {
                            const match = onClickAttr.match(/'([^']+)'/);
                            if (match && match[1]) {
                                const tooltipContent = document.getElementById(match[1]);
                                if (tooltipContent) descText = tooltipContent.innerHTML;
                            }
                        }
                    }
                    const metaBadges = row.querySelectorAll('.price-badge');
                    let costHtml = "";
                    metaBadges.forEach(badge => { costHtml += `<div>${badge.textContent}</div>`; });

                    if (checkbox && (checkbox.id === 'TgVkAvito' || checkbox.id === 'OMNIKnopka') || (number && number.id === 'KolvoSaitov')) {
                         costHtml = `<div class="price-badge">безлимитно</div>`;
                    }
                    if (select && select.id === "RegionDostavki") {
                        const regCost = document.getElementById('cost-RegionDostavki-placeholder');
                        let costDisplay = "";
                        if(regCost && regCost.textContent) costDisplay = `<div>${regCost.textContent}</div>`;
                        tableRows.push(`<tr><td style="width:70%"><div class="print-row-name">${nameText}</div><div style="margin-top:4px; font-weight:400; color:#555; font-size:11px;">${valueText}</div>${descText ? `<div class="print-row-desc">${descText}</div>` : ''}</td><td style="width:30%"><div class="print-row-value">${costDisplay}</div></td></tr>`);
                        return;
                    }
                    if (number && number.id === 'KolvoFMC') {
                         const fmcCost = row.closest('.fmc-subgroup')?.querySelector('.fmc-cost-row .price-badge');
                         let finalFmcCost = "";
                         if(fmcCost) finalFmcCost = `<div>${fmcCost.textContent}</div>`;
                         pendingFMC = { name: nameText, val: valueText, cost: finalFmcCost, desc: descText };
                         return;
                    }
                    if (select && select.id === 'TarifFMC') {
                        if (pendingFMC) {
                            tableRows.push(`<tr><td style="width:70%"><div class="print-row-name">${pendingFMC.name} <span style="font-weight:400; color:#555;">(${pendingFMC.val})</span></div><div class="print-row-name" style="margin-top:6px;">${nameText} <span style="font-weight:400; color:#555;">(${valueText})</span></div></td><td style="width:30%; vertical-align:middle;"><div class="print-row-value">${pendingFMC.cost}</div></td></tr>`);
                            pendingFMC = null;
                        } else {
                             tableRows.push(`<tr><td style="width:70%"><div class="print-row-name">${nameText} <span style="font-weight:400; color:#555;">(${valueText})</span></div></td><td style="width:30%"><div class="print-row-value">${costHtml}</div></td></tr>`);
                        }
                        return;
                    }
                    tableRows.push(`<tr><td style="width:70%"><div class="print-row-name">${nameText} <span style="font-weight:400; color:#555;">(${valueText})</span></div>${descText ? `<div class="print-row-desc">${descText}</div>` : ''}</td><td style="width:30%"><div class="print-row-value">${costHtml}</div></td></tr>`);
                }
            });
            if (pendingFMC) {
                 tableRows.push(`<tr><td style="width:70%"><div class="print-row-name">${pendingFMC.name} <span style="font-weight:400; color:#555;">(${pendingFMC.val})</span></div></td><td style="width:30%"><div class="print-row-value">${pendingFMC.cost}</div></td></tr>`);
            }
            if (tableRows.length > 0) {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'print-section';
                sectionDiv.innerHTML = `<div class="print-section-title">${titleText}</div><table class="print-table"><tbody>${tableRows.join('')}</tbody></table>`;
                container.appendChild(sectionDiv);
            }
        });

        document.getElementById('print-total-monthly').textContent = document.getElementById('total-monthly').textContent + " ₽ / мес";
        document.getElementById('print-total-minimal').textContent = document.getElementById('total-minimal').textContent;
        document.getElementById('print-total-connection').textContent = document.getElementById('total-connection').textContent;
        document.getElementById('print-total-delivery').textContent = document.getElementById('total-delivery').textContent;
        document.getElementById('print-total-guarantee').textContent = document.getElementById('total-guarantee').textContent;
        
        ['print-total-minimal', 'print-total-connection', 'print-total-delivery', 'print-total-guarantee'].forEach(id => {
            const el = document.getElementById(id);
            const row = el.closest('.print-total-row');
            if(el.textContent.trim() === "0 ₽" || el.textContent.trim() === "0 ₽ / мес") row.style.display = 'none';
            else row.style.display = 'flex';
        });

        document.getElementById('managerModal').classList.remove('open');

        // ===============================================
        // ЛОГИКА ОТПРАВКИ
        // ===============================================

        const isWebApp = (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData && window.Telegram.WebApp.initData.length > 0);
        const isMobile = window.matchMedia('(max-width: 900px)').matches;

        if (isWebApp) {
            // WebApp -> Сервер -> Бот
            const tg = window.Telegram.WebApp;
            tg.ready();
            const userId = tg.initDataUnsafe?.user?.id;

            if (!userId) {
                showToast("Ошибка", "Нет ID пользователя. Перезапустите бота.");
                return;
            }

            const btn = document.querySelector('.btn-manager-print');
            const originalText = btn.textContent;
            btn.textContent = "Отправка в чат...";
            btn.disabled = true;

            try {
                const printContent = document.getElementById('print-area').innerHTML;
                const styles = document.querySelector('style').innerHTML;

                const response = await fetch(SERVER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        htmlContent: printContent,
                        cssContent: styles,
                        userId: userId
                    })
                });

                if (response.ok) {
                    showToast("✅ Готово!", "КП успешно отправлено в чат с ботом.", 0);
                    
                    // Ждем 4 секунды
                    setTimeout(() => {
                        tg.close();
                    }, 4000);
                } else {
                    showToast("Ошибка", "Сервер вернул ошибку при отправке. Повторите позже.");
                }
            } catch (e) {
                console.error(e);
                showToast("Ошибка сети", e.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }

        } else if (isMobile) {
            // --- МОБИЛЬНЫЙ БРАУЗЕР ---
            
            // 1. Показываем уведомление (висит 10 секунд)
            showToast("⏳ Формирование файла...", "Если скачивание не началось — значит браузер блокирует его.<br>Нажмите <b>•••</b> сверху &rarr; <b>Открыть в браузере</b>.", 10000);

            // 2. Скачивание
            const element = document.getElementById('print-area');
            document.body.classList.add('pdf-mode');
            window.scrollTo(0, 0);
            
            const opt = {
              margin:       5,
              filename:     'UIS - коммерческое предложение.pdf',
              image:        { type: 'jpeg', quality: 0.98 },
              html2canvas:  { scale: 2, useCORS: true, letterRendering: true, scrollY: 0, scrollX: 0, windowWidth: 800 },
              jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
              pagebreak:    { mode: ['css', 'legacy'] } 
            };

            html2pdf().set(opt).from(element).save().then(function(){
                document.body.classList.remove('pdf-mode');
                // Если скачалось (Хром) - можно скрыть тост раньше
                setTimeout(() => {
                    document.getElementById('mobile-toast').style.display = 'none';
                }, 4000); 
            }).catch(err => {
                document.body.classList.remove('pdf-mode');
            });

        } else {
            // --- ДЕСКТОП ---
            setTimeout(() => {
                window.print();
            }, 300);
        }
    }

    function resetForm() {
        document.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => {
            if(!input.disabled && !input.id.startsWith("mgr")) input.value = 0;
        });
        document.querySelectorAll('input[type="checkbox"]').forEach(box => {
            box.checked = false;
        });
        document.querySelectorAll('select').forEach(select => {
            select.selectedIndex = 0;
            updateSelectTrigger(select.id);
        });
        const vsego = document.getElementById("NomeraVATSVsego");
        if (vsego) vsego.value = 0;

        if (typeof manualChanges !== 'undefined') manualChanges.clear();
        updateTotals();
    }

    function parseVal(id) {
        const el = document.getElementById(id);
        if (!el) return 0;
        const val = el.value || el.textContent;
        const num = parseFloat(val.toString().replace(/[^\d.]/g, ''));
        return isNaN(num) ? 0 : num;
    }

    function getCheckbox(id) { return document.getElementById(id)?.checked ?? false; }
    function getNumber(id) {
        const val = parseFloat(document.getElementById(id)?.value ?? 0);
        return isNaN(val) ? 0 : val;
    }
    function getSelect(id) { return document.getElementById(id)?.value ?? ""; }

    const formulaMap = {
        VATS: { cost: () => getCheckbox("VATS") ? 1200 : 0 },
        VATSPRO: { cost: () => getCheckbox("VATSPRO") ? 2200 : 0 },
        KolvoSotrudnikovVATS: {
            limit: () => {
                const val = getNumber("KolvoSotrudnikovVATS");
                const vatspro = getCheckbox("VATSPRO");
                return val < 4 ? 0 : (val - 3) * (vatspro ? 200 : 120);
            }
        },
        DlitelnostHraneniyaVATS: {
            limit: () => {
                const ar = getSelect("DlitelnostHraneniyaAR");
                const vats = getSelect("DlitelnostHraneniyaVATS");
                const price = { "1 месяц": 500, "3 месяца": 1000, "6 месяцев": 1500, "1 год": 3000, "2 года": 5000, "4 года": 7000 };
                if (!vats || vats === "0") return 0;
                if (!ar || ar === "0") return price[vats] || 0;
                if ((price[ar] || 0) > (price[vats] || 0)) return "учтено в KT";
                return price[vats] || 0;
            }
        },
        LiniyGrupovogoVizova: {
            limit: () => {
                const val = getNumber("LiniyGrupovogoVizova");
                if (val < 4) return 0;
                if (val < 51) return (val - 3) * 190;
                return "уменьшите до 50";
            }
        },
        LiniyIshodyashihZvonkov: {
            limit: () => {
                const val = getNumber("LiniyIshodyashihZvonkov");
                if (val < 31) return 0;
                if (val < 101) return (val - 30) * 190;
                return "уменьшите до 100";
            }
        },
        KolvoSIPTrankov: { cost: () => { const val = getNumber("KolvoSIPTrankov"); return val < 1501 ? val * 400 : "уменьшите до 1500"; } },
        KanalnostSIPTrankov: { limit: () => { const val = getNumber("KanalnostSIPTrankov"); if (val < 31) return 0; if (val < 61) return 1000; if (val < 91) return 1500; if (val < 181) return 3000; return 0; } },
        KolvoSIPURI: { cost: () => { const val = getNumber("KolvoSIPURI"); return val < 1501 ? val * 100 : "уменьшите до 1500"; } },
        KolvoSIPAkkauntov: { cost: () => { const val = getNumber("KolvoSIPAkkauntov"); return val < 1501 ? val * 300 : "уменьшите до 1500"; } },
        KanalnostSIPAkkauntov: { limit: () => { const val = getNumber("KanalnostSIPAkkauntov"); if (val < 31) return 0; if (val < 61) return 1000; if (val < 91) return 1500; if (val < 181) return 3000; return 0; } },
        NomeraVATS: { cost: () => getNumber("NomeraVATS") * 300 },
        NomeraVATS8800: { cost: () => getNumber("NomeraVATS8800") * 590 },
        KolvoSvoihNomerov: { cost: () => { const val = getNumber("KolvoSvoihNomerov"); if (val < 1) return 0; if (val < 11) return val * 200; return 2000 + ((val - 10) * 100); } },
        KolvoFMC: {
            cost: () => {
                const tarif = document.getElementById("TarifFMC")?.value || "";
                const count = getNumber("KolvoFMC");
                let price = 0;
                switch (tarif) {
                    case "200 минут, 1Гб интернета": price = 790; break;
                    case "600 минут, 5Гб интернета": price = 1290; break;
                    case "800 минут, 10Гб интернета": price = 1990; break;
                    case "2000 минут, 20Гб интернета": price = 4490; break;
                    case "15 минут, 0,2Гб интернета": price = 390; break;
                }
                return price * count;
            }
        },
        NomeraVATSVsego: { limit: () => { const val = getNumber("NomeraVATSVsego"); return val < 4 ? 0 : (val - 3) * 100; } },
        OMNI: { cost: () => getCheckbox("OMNI") ? 2600 : 0 },
        KolvoSotrudnikovOMNI: {
            limit: () => {
                const val = getNumber("KolvoSotrudnikovOMNI");
                if (val < 4) return 0;
                if (val < 21) return (val - 3) * 590;
                if (val < 31) return (val - 3) * 540;
                if (val < 41) return (val - 3) * 490;
                if (val < 101) return (val - 3) * 440;
                if (val < 201) return (val - 3) * 390;
                if (val < 1001) return (val - 3) * 340;
                if (val < 10001) return (val - 3) * 290;
                return "уменьшите до 10000";
            }
        },
        KolvoWA: { limit: () => getNumber("KolvoWA") * 990 },
        KolvoWABA: { cost: () => getNumber("KolvoWABA") > 0 ? 4000 : 0, limit: () => getNumber("KolvoWABA") * 5000 },
        TgVkAvito: { cost: () => getCheckbox("TgVkAvito") ? "вкл" : 0 },
        OMNIKnopka: { cost: () => getCheckbox("OMNIKnopka") ? "вкл" : 0 },
        AR: { cost: () => getCheckbox("AR") ? 2000 : 0 },
        KolvoSaitov: { limit: () => getNumber("KolvoSaitov") ? "вкл" : 0 },
        KolvoPolzovatelskihIstochnikov: { limit: () => { const val = getNumber("KolvoPolzovatelskihIstochnikov"); if (val === 250) return 1000; if (val === 500) return 2000; if (val === 5000) return 3000; return 0; } },
        PaketTrafika: {
            limit: () => {
                const val = document.getElementById("PaketTrafika")?.value || "";
                const num = parseInt(val);
                if (val === "безлимит") return 50000;
                if (num === 0 || num === 10000) return 0;
                if (num === 20000) return 1000;
                if (num === 50000) return 3500;
                if (num === 100000) return 7500;
                if (num === 200000) return 15000;
                if (num === 500000) return 30000;
                return 50000;
            }
        },
        KT: { cost: () => getCheckbox("KT") ? 1500 : 0 },
        NomeraKT: { cost: () => getNumber("NomeraKT") * 300 },
        NomeraKT8800: { cost: () => getNumber("NomeraKT8800") * 590 },
        DlitelnostHraneniyaAR: {
            limit: () => {
                const values = { "0": 0, "1 месяц": 500, "3 месяца": 1000, "6 месяцев": 1500, "1 год": 3000, "2 года": 5000, "4 года": 7000 };
                const vats = document.getElementById("DlitelnostHraneniyaVATS")?.value || "";
                const ar = document.getElementById("DlitelnostHraneniyaAR")?.value || "";
                if (ar === "0") return 0;
                const vatsVal = values[vats] ?? 0;
                const arVal = values[ar] ?? 0;
                return vatsVal >= arVal ? "учтено в ВАТС" : arVal;
            }
        },
        EmailTreking: { cost: () => document.getElementById("EmailTreking")?.value !== "нет" ? 2000 : 0, limit: () => document.getElementById("EmailTreking")?.value === "больше 100 шт." ? 1000 : 0 },
        KonstruktorOtchetov: { cost: () => getCheckbox("KonstruktorOtchetov") ? 4000 : 0 },
        AnalitikaProdaj: { cost: () => getCheckbox("AnalitikaProdaj") ? 3000 : 0 },
        IntegraciyaSVidjetami: { cost: () => getCheckbox("IntegraciyaSVidjetami") ? 2000 : 0 },
        AmoBitrix: { cost: () => getCheckbox("AmoBitrix") ? 1500 : 0 },
        IntegraciyaOtraslevie: { cost: () => getCheckbox("IntegraciyaOtraslevie") ? 2000 : 0 },
        UvedomlenieOSobitiyah: { cost: () => getCheckbox("UvedomlenieOSobitiyah") ? 800 : 0 },
        VneshnieATS: { cost: () => getCheckbox("VneshnieATS") ? 3000 : 0 },
        SpasenieKommunikatsiy: { cost: () => getCheckbox("SpasenieKommunikatsiy") ? 1600 : 0 },
        AvtoperezvonPoZayavkam: { cost: () => getCheckbox("AvtoperezvonPoZayavkam") ? 1600 : 0 },
        VezdeKakDoma: { cost: () => getCheckbox("VezdeKakDoma") ? 2000 : 0 }
    };

    const rules = {
      VATS: (context) => {
        const val = getCheckbox("VATS");
        if (val === true) {
          context.select("DlitelnostHraneniyaVATS", "1 неделя");
          if (getNumber("KolvoSotrudnikovVATS") < 3) context.set("KolvoSotrudnikovVATS", 3);
          if (getNumber("LiniyGrupovogoVizova") < 3) context.set("LiniyGrupovogoVizova", 3);
          if (getNumber("LiniyIshodyashihZvonkov") < 30) context.set("LiniyIshodyashihZvonkov", 30);
        } else {
          context.set("KolvoSotrudnikovVATS", 0);
          context.set("LiniyGrupovogoVizova", 0);
          context.set("LiniyIshodyashihZvonkov", 0);
          context.set("KolvoSIPTrankov", 0);
          context.set("KolvoSIPURI", 0);
          context.set("KolvoSIPAkkauntov", 0);
          context.set("NomeraVATS", 0);
          context.set("NomeraVATS8800", 0);
          context.set("KolvoSvoihNomerov", 0);
          context.set("KolvoFMC", 0);

          context.set("VATSPRO", false);
          context.select("DlitelnostHraneniyaVATS", 0);
          context.select("KanalnostSIPTrankov", 0);
          context.select("KanalnostSIPAkkauntov", 0);
          context.select("TarifFMC", "нет");
          context.select("RegionDostavki", "нет");

          context.set("VneshnieATS", false);
          context.set("SpasenieKommunikatsiy", false);
          context.set("AvtoperezvonPoZayavkam", false);
          context.set("VezdeKakDoma", false);

          if (!getCheckbox("OMNI") && !getCheckbox("AnalitikaProdaj")) {
            context.set("AmoBitrix", false);
          }

          context.set("IntegraciyaOtraslevie", false);

          if (
            getCheckbox("UvedomlenieOSobitiyah") === true &&
            !getCheckbox("OMNI") &&
            !getCheckbox("AR")
          ) {
            context.set("UvedomlenieOSobitiyah", false);
          }
        }
      },
      VATSPRO: (context) => {
        if (getCheckbox("VATSPRO") && !getCheckbox("VATS")) {
          context.set("VATS", true);
        }
      },
      KolvoSotrudnikovVATS: (context) => {
        const val = getNumber("KolvoSotrudnikovVATS");
        if (val > 0 && !getCheckbox("VATS")) {
          context.set("VATS", true);
        }

        if (val > 0 && val < 3) {
          context.set("KolvoSotrudnikovVATS", 3);
        }

        if (
          val === 0 &&
          getNumber("KolvoSIPTrankov") === 0 &&
          getNumber("KolvoSIPURI") === 0 &&
          getNumber("KolvoSIPAkkauntov") === 0 &&
          getCheckbox("VATS") === true
        ) {
          context.set("VATS", false);
        }
      },
      DlitelnostHraneniyaVATS: (context) => {
        const val = document.getElementById("DlitelnostHraneniyaVATS")?.value;
        if (val !== "0" && !getCheckbox("VATS")) {
          context.set("VATS", true);
        }
        if (val === "0" && getCheckbox("VATS")) {
          context.select("DlitelnostHraneniyaVATS", "1 неделя");
        }
      },
      LiniyGrupovogoVizova: (context) => {
        const val = getNumber("LiniyGrupovogoVizova");
        if (val > 0 && !getCheckbox("VATS")) {
          context.set("VATS", true);
        }
        if (val >= 0 && val < 3 && getCheckbox("VATS")) {
          context.set("LiniyGrupovogoVizova", 3);
        }
      },
      LiniyIshodyashihZvonkov: (context) => {
        const val = getNumber("LiniyIshodyashihZvonkov");
        if (val > 0 && !getCheckbox("VATS")) {
          context.set("VATS", true);
        }
        if (val >= 0 && val < 30 && getCheckbox("VATS")) {
          context.set("LiniyIshodyashihZvonkov", 30);
        }
      },
      KolvoSIPTrankov: (context) => {
        const val = getNumber("KolvoSIPTrankov");
        const kanalnost = document.getElementById("KanalnostSIPTrankov")?.value;
        if (val > 0) {
          if (!getCheckbox("VATS")) {
            context.set("VATS", true);
          }
          if (parseInt(kanalnost, 10) < 30) {
            context.select("KanalnostSIPTrankov", "30");
          }
        }
        if (
          val === 0 &&
          getNumber("KolvoSotrudnikovVATS") === 0 &&
          getNumber("KolvoSIPURI") === 0 &&
          getNumber("KolvoSIPAkkauntov") === 0 &&
          getCheckbox("VATS") === true
        ) {
          context.set("VATS", false);
        }
        if (val === 0 && kanalnost !== "0") {
          context.select("KanalnostSIPTrankov", "0");
        }
      },
      KanalnostSIPTrankov: (context) => {
        const val = document.getElementById("KanalnostSIPTrankov")?.value;
        if (val !== "0") {
          if (!getCheckbox("VATS")) {
            context.set("VATS", true);
          }
          if (getNumber("KolvoSIPTrankov") === 0) {
            context.set("KolvoSIPTrankov", 1);
          }
        } else {
          if (getNumber("KolvoSIPTrankov") !== 0) {
            context.set("KolvoSIPTrankov", 0);
          }
        }
      },
      KolvoSIPURI: (context) => {
        const val = getNumber("KolvoSIPURI");
        if (val > 0 && !getCheckbox("VATS")) {
          context.set("VATS", true);
        }
        if (
          val === 0 &&
          getNumber("KolvoSotrudnikovVATS") === 0 &&
          getNumber("KolvoSIPTrankov") === 0 &&
          getNumber("KolvoSIPAkkauntov") === 0 &&
          getCheckbox("VATS") === true
        ) {
          context.set("VATS", false);
        }
      },
      KolvoSIPAkkauntov: (context) => {
        const val = getNumber("KolvoSIPAkkauntov");
        const kanalnost = document.getElementById("KanalnostSIPAkkauntov")?.value;
        if (val > 0) {
          if (!getCheckbox("VATS")) {
            context.set("VATS", true);
          }
          if (parseInt(kanalnost, 10) < 30) {
            context.select("KanalnostSIPAkkauntov", "30");
          }
        }
        if (
          val === 0 &&
          getNumber("KolvoSotrudnikovVATS") === 0 &&
          getNumber("KolvoSIPURI") === 0 &&
          getNumber("KolvoSIPTrankov") === 0 &&
          getCheckbox("VATS") === true
        ) {
          context.set("VATS", false);
        }
        if (val === 0 && kanalnost !== "0") {
          context.select("KanalnostSIPAkkauntov", "0");
        }
      },
      KanalnostSIPAkkauntov: (context) => {
        const val = document.getElementById("KanalnostSIPAkkauntov")?.value;
        if (val !== "0") {
          if (!getCheckbox("VATS")) {
            context.set("VATS", true);
          }
          if (getNumber("KolvoSIPAkkauntov") === 0) {
            context.set("KolvoSIPAkkauntov", 1);
          }
        } else {
          if (getNumber("KolvoSIPAkkauntov") !== 0) {
            context.set("KolvoSIPAkkauntov", 0);
          }
        }
      },
      NomeraVATS: (context) => {
        const val = getNumber("NomeraVATS");
        if (val > 0 && !getCheckbox("VATS")) {
          context.set("VATS", true);
        }
      },
      NomeraVATS8800: (context) => {
        const val = getNumber("NomeraVATS8800");
        if (val > 0 && !getCheckbox("VATS")) {
          context.set("VATS", true);
        }
      },
      KolvoSvoihNomerov: (context) => {
        const val = getNumber("KolvoSvoihNomerov");
        if (val > 0 && !getCheckbox("VATS")) {
          context.set("VATS", true);
        }
      },
      KolvoFMC: (context) => {
        const val = getNumber("KolvoFMC");
        if (val > 0) {
          if (!getCheckbox("VATS")) {
            context.set("VATS", true);
          }
          const tarif = document.getElementById("TarifFMC")?.value;
          if (tarif === "нет") {
            const options = document.getElementById("TarifFMC")?.options;
            if (options?.length > 1) {
              context.select("TarifFMC", options[1].value);
            }
          }
        } else {
          if (document.getElementById("TarifFMC")?.value !== "нет") {
            context.select("TarifFMC", "нет");
          }
          if (document.getElementById("RegionDostavki")?.value !== "нет") {
            context.select("RegionDostavki", "нет");
          }
        }
      },
      TarifFMC: (context) => {
        const val = document.getElementById("TarifFMC")?.value;
        if (val && val !== "нет") {
          if (!getCheckbox("VATS")) {
            context.set("VATS", true);
          }
          if (getNumber("KolvoFMC") === 0) {
            context.set("KolvoFMC", 1);
          }
        } else {
          if (getNumber("KolvoFMC") !== 0) {
            context.set("KolvoFMC", 0);
          }
          if (document.getElementById("RegionDostavki")?.value !== "нет") {
            context.select("RegionDostavki", "нет");
          }
        }
      },
      RegionDostavki: (context) => {
        const val = document.getElementById("RegionDostavki")?.value;
        if (val && val !== "нет") {
          if (!getCheckbox("VATS")) {
            context.set("VATS", true);
          }
          if (getNumber("KolvoFMC") === 0) {
            context.set("KolvoFMC", 1);
          }
          const tarif = document.getElementById("TarifFMC")?.value;
          if (tarif === "нет") {
            const options = document.getElementById("TarifFMC")?.options;
            if (options?.length > 1) {
              context.select("TarifFMC", options[1].value);
            }
          }
        }
      },
      OMNI: (context) => {
        const val = getCheckbox("OMNI");
        if (val === true) {
          if (getNumber("KolvoSotrudnikovOMNI") < 3) {
            context.set("KolvoSotrudnikovOMNI", 3);
          }
          if (!getCheckbox("TgVkAvito")) {
            context.set("TgVkAvito", true);
          }
          if (!getCheckbox("OMNIKnopka")) {
            context.set("OMNIKnopka", true);
          }
        } else {
          context.set("KolvoSotrudnikovOMNI", 0);
          context.set("KolvoWA", 0);
          context.set("KolvoWABA", 0);
          context.set("TgVkAvito", false);
          context.set("OMNIKnopka", false);

          if (!getCheckbox("VATS") && !getCheckbox("AnalitikaProdaj")) {
            context.set("AmoBitrix", false);
          }
          if (!getCheckbox("VATS") && !getCheckbox("AR")) {
            context.set("UvedomlenieOSobitiyah", false);
          }
        }
      },
      KolvoSotrudnikovOMNI: (context) => {
        const val = getNumber("KolvoSotrudnikovOMNI");
        if (val > 0) {
          if (!getCheckbox("OMNI")) {
            context.set("OMNI", true);
          }
          if (val < 3) {
            context.set("KolvoSotrudnikovOMNI", 3);
          }
        }
        if (val === 0 && getCheckbox("OMNI")) {
          context.set("OMNI", false);
        }
      },
      KolvoWA: (context) => {
        if (getNumber("KolvoWA") > 0 && !getCheckbox("OMNI")) {
          context.set("OMNI", true);
        }
      },
      KolvoWABA: (context) => {
        if (getNumber("KolvoWABA") > 0 && !getCheckbox("OMNI")) {
          context.set("OMNI", true);
        }
      },
      TgVkAvito: (context) => {
        if (getCheckbox("TgVkAvito") && !getCheckbox("OMNI")) {
          context.set("OMNI", true);
        }
      },
      OMNIKnopka: (context) => {
        if (getCheckbox("OMNIKnopka") && !getCheckbox("OMNI")) {
          context.set("OMNI", true);
        }
      },
      AR: (context) => {
        if (getCheckbox("AR")) {
          if (getNumber("KolvoSaitov") === 0) {
            context.set("KolvoSaitov", 1);
          }
          context.select("KolvoPolzovatelskihIstochnikov", "50");
          context.select("PaketTrafika", "10000");
        } else {
          context.set("KolvoSaitov", 0);
          context.select("KolvoPolzovatelskihIstochnikov", "0");
          context.select("PaketTrafika", "0");
          context.select("EmailTreking", "нет");

          context.set("KT", false);
          context.set("NomeraKT", 0);
          context.set("NomeraKT8800", 0);
          context.select("DlitelnostHraneniyaAR", "0");
          context.set("KonstruktorOtchetov", false);
          context.set("AnalitikaProdaj", false);
          context.set("IntegraciyaSVidjetami", false);
          context.set("AvtoperezvonPoZayavkam", false);
          if (!getCheckbox("VATS") && !getCheckbox("OMNI")) {
            context.set("UvedomlenieOSobitiyah", false);
          }
        }
      },
      KolvoSaitov: (context) => {
        if (getNumber("KolvoSaitov") > 0 && !getCheckbox("AR")) {
          context.set("AR", true);
        }
      },
      KolvoPolzovatelskihIstochnikov: (context) => {
        const val = document.getElementById("KolvoPolzovatelskihIstochnikov")?.value;
        if (val && val !== "0" && !getCheckbox("AR")) {
          context.set("AR", true);
        }
      },
      PaketTrafika: (context) => {
        const val = document.getElementById("PaketTrafika")?.value;
        if (val && val !== "0" && !getCheckbox("AR")) {
          context.set("AR", true);
        }
      },
      KT: (context) => {
        const val = getCheckbox("KT");
        if (val === true && !getCheckbox("AR")) {
          context.set("AR", true);
        }
        if (val === false) {
          context.set("NomeraKT", 0);
          context.set("NomeraKT8800", 0);
          context.select("DlitelnostHraneniyaAR", "0");
        }
      },
      NomeraKT: (context) => {
        if (getNumber("NomeraKT") > 0 && !getCheckbox("KT")) {
          context.set("KT", true);
        }
      },
      NomeraKT8800: (context) => {
        if (getNumber("NomeraKT8800") > 0 && !getCheckbox("KT")) {
          context.set("KT", true);
        }
      },
      DlitelnostHraneniyaAR: (context) => {
        const val = document.getElementById("DlitelnostHraneniyaAR")?.value;
        if (val !== "0" && !getCheckbox("KT")) {
          context.set("KT", true);
        }
        if (val === "0" && getCheckbox("KT")) {
          context.select("DlitelnostHraneniyaAR", "1 неделя");
        }
      },
      EmailTreking: (context) => {
        const val = document.getElementById("EmailTreking")?.value;
        if (val && val !== "нет" && !getCheckbox("AR")) {
          context.set("AR", true);
        }
      },
      KonstruktorOtchetov: (context) => {
        if (getCheckbox("KonstruktorOtchetov") && !getCheckbox("AR")) {
          context.set("AR", true);
        }
      },
      AnalitikaProdaj: (context) => {
        if (getCheckbox("AnalitikaProdaj")) {
          if (!getCheckbox("AR")) {
            context.set("AR", true);
          }
          if (!getCheckbox("AmoBitrix")) {
            context.set("AmoBitrix", true);
          }
        } else {
          if (!getCheckbox("OMNI") && !getCheckbox("VATS")) {
            context.set("AmoBitrix", false);
          }
        }
      },
      IntegraciyaSVidjetami: (context) => {
        if (getCheckbox("IntegraciyaSVidjetami") && !getCheckbox("AR")) {
          context.set("AR", true);
        }
      },
      IntegraciyaOtraslevie: (context) => {
        if (getCheckbox("IntegraciyaOtraslevie") && !getCheckbox("VATS")) {
          context.set("VATS", true);
        }
      },
      VneshnieATS: (context) => {
        if (getCheckbox("VneshnieATS") && !getCheckbox("VATS")) {
          context.set("VATS", true);
        }
      },
      AmoBitrix: (context) => {
        if (getCheckbox("AmoBitrix")) {
          if (!getCheckbox("VATS") && !getCheckbox("OMNI") && !getCheckbox("AnalitikaProdaj")) {
            context.set("VATS", true);
          }
        } else {
          if (getCheckbox("AnalitikaProdaj")) {
            context.set("AnalitikaProdaj", false);
          }
        }
      },
      VezdeKakDoma: (context) => {
        if (getCheckbox("VezdeKakDoma") && !getCheckbox("VATS")) {
          context.set("VATS", true);
        }
      },
      UvedomlenieOSobitiyah: (context) => {
        if (getCheckbox("UvedomlenieOSobitiyah")) {
          if (getCheckbox("SpasenieKommunikatsiy")) {
            context.set("UvedomlenieOSobitiyah", false);
          } else if (!getCheckbox("VATS") && !getCheckbox("OMNI") && !getCheckbox("AR")) {
            context.set("VATS", true);
          }
        }
      },
      SpasenieKommunikatsiy: (context) => {
        if (getCheckbox("SpasenieKommunikatsiy")) {
          document.getElementById('UvedomlenieOSobitiyah').disabled = true;
          if (!getCheckbox("VATS")) {
            context.set("VATS", true);
          }
          if (getCheckbox("UvedomlenieOSobitiyah")) {
            context.set("UvedomlenieOSobitiyah", false);
          }
        } else {
          document.getElementById('UvedomlenieOSobitiyah').disabled = false;
        }
      },
      AvtoperezvonPoZayavkam: (context) => {
        if (getCheckbox("AvtoperezvonPoZayavkam")) {
          if (!getCheckbox("VATS")) {
            context.set("VATS", true);
          }
          if (!getCheckbox("AR")) {
            context.set("AR", true);
          }
        }
      },
    };

    const manualChanges = new Set();
    let cascadeQueue = [];
    let isProcessing = false;

    function runCascade(startField) {
        if (isProcessing) { manualChanges.add(startField); return; }
        cascadeQueue = [startField];
        isProcessing = true;
        let depth = 0; const maxDepth = 3;
        const context = {
            set: (id, value) => {
                const el = document.getElementById(id); if (!el) return;
                const current = el.type === "checkbox" ? el.checked : el.value;
                const changedByUser = manualChanges.has(id);
                const isSame = current == value; 
                if (isSame || changedByUser) return;
                
                if (el.type === "checkbox") el.checked = value; else el.value = value;
                cascadeQueue.push(id);
            },
            select: (id, value) => {
                const el = document.getElementById(id); if (!el) return;
                const changedByUser = manualChanges.has(id);
                const isSame = el.value === value;
                if (isSame || changedByUser) return;
                
                el.value = value;
                updateSelectTrigger(id);
                cascadeQueue.push(id);
            }
        };
        while (cascadeQueue.length && depth < maxDepth) {
            const current = cascadeQueue.shift();
            const rule = rules[current];
            if (rule) rule(context);
            depth++;
        }
        isProcessing = false;
        manualChanges.clear();
        updateTotals();
    }

    function updateTotals() {
        const sumAll = parseVal("NomeraVATS") + parseVal("NomeraVATS8800") + parseVal("KolvoFMC");
        const vsego = document.getElementById("NomeraVATSVsego");
        if(vsego) vsego.value = sumAll;

        Object.entries(formulaMap).forEach(([id, formula]) => {
            const costEl = document.getElementById(`cost-${id}`);
            const limitEl = document.getElementById(`limit-${id}`);
            
            if(costEl) costEl.innerHTML = '';
            if(limitEl && limitEl !== costEl) limitEl.innerHTML = '';

            let costVal = null;
            let limitVal = null;

            if (formula.cost) {
                const val = formula.cost();
                if (typeof val === "number" && val > 0) costVal = val;
                else if (val && val !== 0 && typeof val === "string") costVal = val;
            }

            if (formula.limit) {
                const val = formula.limit();
                if (typeof val === "number" && val > 0) limitVal = val;
                else if (val && val !== 0 && typeof val === "string") limitVal = val;
            }

            const createBadge = (val, type) => {
                const badge = document.createElement('div');
                badge.className = `price-badge ${type}`;
                const isNum = typeof val === 'number';
                badge.textContent = isNum ? `${val.toLocaleString('ru-RU')} ₽${type === 'cost' ? ' / мес' : ''}` : val;
                
                // Исправленный текст лимитов
                if(type === 'limit' && isNum) badge.textContent = `+${val.toLocaleString('ru-RU')} ₽ / мес - расширение`;
                
                if(String(val).includes("вкл")) badge.textContent = "Включено";
                if(String(val).includes("уменьшите")) { badge.textContent = val; badge.style.color = "red"; }
                return badge;
            };

            if(costEl && costVal !== null) {
                costEl.appendChild(createBadge(costVal, 'cost'));
            }

            if(limitVal !== null) {
                if(limitEl && limitEl !== costEl) {
                    limitEl.appendChild(createBadge(limitVal, 'limit'));
                } else if(costEl) {
                     costEl.appendChild(createBadge(limitVal, 'limit'));
                }
            }
        });

        let total = 0;
        Object.entries(formulaMap).forEach(([id, formula]) => {
            if(formula.cost) {
                const v = formula.cost();
                if(typeof v === 'number') total += v;
            }
            if(formula.limit) {
                const v = formula.limit();
                if(typeof v === 'number') total += v;
            }
        });

        const totalFormatted = total.toLocaleString('ru-RU');
        document.getElementById('total-monthly').textContent = totalFormatted;

        const nom8800 = parseVal("NomeraVATS8800") + parseVal("NomeraKT8800");
        const minimal = (nom8800 * 700).toLocaleString('ru-RU');
        document.getElementById('total-minimal').textContent = minimal + " ₽ / мес";

        const connect = (parseVal("NomeraVATS") * 300 + parseVal("KolvoFMC") * 250).toLocaleString('ru-RU');
        document.getElementById('total-connection').textContent = connect + " ₽";

        const region = (document.getElementById("RegionDostavki")?.value || "").trim();
        let delPrice = 0;
        if (region.includes("Москва") || region.includes("Петербург")) delPrice = 500;
        else if (region.includes("Центральная")) delPrice = 750;
        else if (region.includes("Юг")) delPrice = 1000;
        else if (region.includes("Дальний")) delPrice = 1300;
        document.getElementById('total-delivery').textContent = delPrice + " ₽";

        const regionPlaceholder = document.getElementById('cost-RegionDostavki-placeholder');
        if (regionPlaceholder) {
            if (delPrice > 0) {
                regionPlaceholder.className = 'price-badge cost';
                // Исправлено: без скобок
                regionPlaceholder.textContent = `+${delPrice.toLocaleString('ru-RU')} ₽ - доставка`;
            } else {
                regionPlaceholder.textContent = '';
                regionPlaceholder.className = '';
            }
        }

        const monthly = total;
        const minimalNum = nom8800 * 700;
        const connectionNum = parseVal("NomeraVATS") * 300 + parseVal("KolvoFMC") * 250;
        const baseSum = monthly + minimalNum + connectionNum;
        const guarantee = baseSum > 0 ? (baseSum < 4000 ? 4000 : baseSum) : 0;
        document.getElementById('total-guarantee').textContent = guarantee.toLocaleString('ru-RU') + " ₽";

        const maxLimit = baseSum <= 10000 ? guarantee * 2 : guarantee * 1.7;
        const guaranteeTooltipText = `Будет "заморожен" на счете как гарантия оплаты и возвращен или учтен при закрытии договора. <br>Максимальный порог кредитного лимита: <b>${maxLimit.toLocaleString('ru-RU')} руб.</b>`;
        document.getElementById('tooltip-guarantee').innerHTML = guaranteeTooltipText;
        
        const printGuaranteeDesc = document.getElementById('print-total-guarantee-desc');
        if(printGuaranteeDesc) printGuaranteeDesc.innerHTML = guaranteeTooltipText;
        
        updateMobileSheet(totalFormatted + " ₽ / мес", minimal + " ₽ / мес", connect + " ₽", delPrice + " ₽", guarantee.toLocaleString('ru-RU') + " ₽");
    }
    
    // --- ФУНКЦИИ СОХРАНЕНИЯ И ВОССТАНОВЛЕНИЯ СОСТОЯНИЯ (URL) ---

    function saveStateToURL() {
        const params = new URLSearchParams();

        document.querySelectorAll('input, select').forEach(el => {
            if (!el.id || el.id.startsWith('mobile-') || el.id.startsWith('total-') || el.id.startsWith('cost-') || el.id.startsWith('limit-')) return;
            
            let val = null;
            
            if (el.type === 'checkbox') {
                if (el.checked) val = '1';
            } else {
                if (el.value && el.value !== '0' && el.value !== 'нет') {
                    val = el.value;
                }
            }

            if (val !== null) {
                params.set(el.id, encodeURIComponent(val));
            }
        });

        const newUrl = window.location.pathname + '?' + params.toString();
        window.history.replaceState(null, '', newUrl);
    }

    function restoreStateFromURL() {
        const params = new URLSearchParams(window.location.search);
        if ([...params].length === 0) return;

        // 1. Сначала восстанавливаем значения в DOM
        params.forEach((encodedVal, key) => {
            const el = document.getElementById(key);
            if (el) {
                const val = decodeURIComponent(encodedVal);
                
                if (el.type === 'checkbox') {
                    el.checked = (val === '1');
                } else {
                    el.value = val;
                }
                
                if (el.tagName === 'SELECT') {
                    updateSelectTrigger(el.id);
                }
            }
        });

        // 2. ЗАПУСКАЕМ ЛОГИКУ
        const cascadeOrder = [
            'VATS', 'VATSPRO', 'OMNI', 'AR', 'KT', 
            'KolvoSotrudnikovVATS', 'KolvoFMC', 'TarifFMC', 'RegionDostavki'
        ];
        
        cascadeOrder.forEach(id => {
            if (params.has(id)) {
                runCascade(id);
            }
        });

        params.forEach((_, key) => {
            if (!cascadeOrder.includes(key)) {
                runCascade(key);
            }
        });

        updateTotals();
    }

    // --- ИНИЦИАЛИЗАЦИЯ ---
    
    // Авто-сохранение URL
    document.querySelectorAll('input, select').forEach(el => {
        el.addEventListener('change', saveStateToURL);
        el.addEventListener('input', saveStateToURL);
    });

    // Инициализация селектов
    document.querySelectorAll('select').forEach(s => updateSelectTrigger(s.id));

    // Восстановление данных
    restoreStateFromURL();
    
    // Финальный расчет
    updateTotals();

</script>

</body>
</html>